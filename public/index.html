<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Key-Server Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <header>
    <div style="display:flex;align-items:center;gap:.6rem">
      <button id="sidebarToggle" aria-label="Men√º √∂ffnen">‚ò∞</button>
      <h1>Key-Server Dashboard</h1>
    </div>
    <button id="themeToggle" aria-label="Design wechseln">üåô</button>
  </header>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SIDEBAR / TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <aside id="sidebar">
    <nav class="tabs">
      <button data-tab="overview" class="active">√úbersicht</button>
      <button data-tab="actions">Aktionen</button>
      <button data-tab="history">Historie</button>
    </nav>
  </aside>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <main>

    <!-- TAB ‚ñ∏ √úbersicht -->
    <div id="overview" class="tab-content">
      <section>
        <h2>Statistik</h2>
        <div>Freie Keys: <strong id="freeCount">0</strong></div>
        <div>Benutzte Keys: <strong id="usedCount">0</strong></div>
        <div>Ung√ºltige Keys: <strong id="invalidCount">0</strong></div>
      </section>

      <section>
        <h2>Freie Keys</h2>
        <div id="listFree" class="key-list"></div>
      </section>

      <section>
        <h2>Aktivierte Keys</h2>
        <div id="listActive" class="key-list"></div>
      </section>
    </div>

    <!-- TAB ‚ñ∏ Aktionen -->
    <div id="actions" class="tab-content" style="display:none">
      <section>
        <h2>Alle Keys</h2>
        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <label><input type="checkbox" id="filterInUse"> nur benutzte</label>
          <input type="text" id="filterAssignedTo" placeholder="Zugewiesen an">
          <button id="loadKeys">Laden</button>
        </div>
        <div id="allKeys" class="result-box"></div>
      </section>

      <section>
        <h2>Neuen Key hinzuf√ºgen</h2>
        <form id="addKeyForm">
          <textarea id="newKey" rows="3" placeholder="XXXXX-XXXXX-XXXXX-XXXXX"></textarea>
          <button type="submit">Hinzuf√ºgen</button>
        </form>
        <div id="addKeyResult" class="result-box"></div>
      </section>

      <section>
        <h2>Freien Key abrufen</h2>
        <button id="getFreeKey">Abrufen</button>
        <div id="freeKey" class="result-box"></div>
      </section>

      <section>
        <h2>Key als benutzt markieren</h2>
        <form id="markInUseForm">
          <input type="number" id="keyId" placeholder="ID">
          <input type="text" id="assignedTo" placeholder="Zugewiesen an">
          <button type="submit">Markieren</button>
        </form>
        <div id="inUseResult" class="result-box"></div>
      </section>

      <section>
        <h2>Key freigeben</h2>
        <form id="releaseForm">
          <input type="number" id="releaseId" placeholder="ID">
          <button type="submit">Freigeben</button>
        </form>
        <div id="releaseResult" class="result-box"></div>
      </section>

      <section>
        <h2>Key ung√ºltig markieren</h2>
        <form id="invalidateForm">
          <input type="number" id="invalidateId" placeholder="ID">
          <button type="submit">Ung√ºltig</button>
        </form>
        <div id="invalidateResult" class="result-box"></div>
      </section>

      <section>
        <h2>Key l√∂schen</h2>
        <form id="deleteForm">
          <input type="number" id="deleteId" placeholder="ID">
          <button type="submit">L√∂schen</button>
        </form>
        <div id="deleteResult" class="result-box"></div>
      </section>
    </div>

    <!-- TAB ‚ñ∏ Historie -->
    <div id="history" class="tab-content" style="display:none">
      <section>
        <h2>Log</h2>
        <div id="historyLog" class="result-box" style="white-space:pre-wrap;"></div>
      </section>
    </div>

  </main>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SCRIPTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
  /* ----------------- Theme & Sidebar ----------------- */
  const themeToggle   = document.getElementById('themeToggle');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebar       = document.getElementById('sidebar');

  function applyTheme(mode){
    document.body.classList.remove('light','dark');
    if (mode) document.body.classList.add(mode);
    themeToggle.textContent = mode === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  }

  themeToggle.addEventListener('click',()=>{
    const now  = document.body.classList.contains('dark') ? 'dark'
                : document.body.classList.contains('light') ? 'light' : null;
    const next = now === 'dark' ? 'light' : 'dark';
    applyTheme(next);
    localStorage.setItem('theme', next);
  });

  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('hidden');
  });

  /* ----------------- Tab Navigation ----------------- */
  document.querySelectorAll('nav.tabs button').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('nav.tabs button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');

      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      document.getElementById(tab).style.display='block';

      /* Sidebar auto-close on mobile */
      if (window.innerWidth < 850) sidebar.classList.add('hidden');
    });
  });

  /* ----------------- Helper ----------------- */
  function displayJson(id,obj){
    const box=document.getElementById(id);
    box.innerHTML='';
    const pre=document.createElement('pre');
    pre.textContent=JSON.stringify(obj,null,2);
    box.appendChild(pre);
  }

  function createActionButton(icon,cls,cb,title){
    const b=document.createElement('button');
    b.className='icon-button '+cls; b.textContent=icon;
    if(title){b.title=title; b.setAttribute('aria-label',title);}
    b.onclick=cb; return b;
  }

  function showFreeKey(txt){
    const box=document.getElementById('freeKey'); box.innerHTML='';
    if(!txt) return;
    const span=document.createElement('span'); span.textContent=txt;
    const copy=createActionButton('üìã','icon-copy',()=>navigator.clipboard.writeText(txt),'Kopieren');
    box.append(span,copy);
  }

  /* ----------------- API Operations ----------------- */
  async function updateStats(){
    const res=await fetch('/keys'); const data=await res.json();
    document.getElementById('freeCount').textContent = data.filter(k=>!k.inUse).length;
    document.getElementById('usedCount').textContent = data.filter(k=>k.inUse).length;
    document.getElementById('invalidCount').textContent = data.filter(k=>k.invalid).length;
  }

  async function renderList(elId,url){
    const res=await fetch(url); const data=await res.json();
    const el=document.getElementById(elId); el.innerHTML='';
    data.sort((a,b)=>a.id-b.id).forEach(k=>{
      const row=document.createElement('div'); row.className='key-row';
      row.innerHTML=`<span>${k.id}: ${k.key}</span>`;
      const acts=document.createElement('div'); acts.className='key-actions';

      acts.append(
        createActionButton('‚úîÔ∏è','icon-use',()=>markKeyInUse(k.id, prompt('Zugewiesen an?')||''),'Benutzen'),
        createActionButton('‚Ü©Ô∏è','icon-release',()=>releaseKey(k.id),'Freigeben'),
        createActionButton('üö´','icon-invalidate',()=>invalidateKey(k.id),'Ung√ºltig'),
        createActionButton('üóëÔ∏è','icon-delete',()=>deleteKey(k.id),'L√∂schen'),
        createActionButton('üìã','icon-copy',()=>navigator.clipboard.writeText(k.key),'Kopieren'),
        createActionButton('üìú','icon-history',()=>{showHistory(k.id);document.querySelector('[data-tab="history"]').click();},'Historie')
      );
      row.appendChild(acts); el.appendChild(row);
    });
  }

  async function loadFreeList(){ renderList('listFree','/keys/free/list'); }
  async function loadActiveList(){ renderList('listActive','/keys/active/list'); }

  async function markKeyInUse(id,assignedTo=''){
    const r=await fetch(`/keys/${id}/inuse`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({assignedTo})});
    const d=await r.json(); displayJson('inUseResult',d);
    updateStats(); loadFreeList(); loadActiveList(); showHistory(id);
  }

  async function releaseKey(id){
    const r=await fetch(`/keys/${id}/release`,{method:'PUT'}); const d=await r.json();
    displayJson('releaseResult',d); updateStats(); loadFreeList(); loadActiveList(); showHistory(id);
  }

  async function invalidateKey(id){
    const r=await fetch(`/keys/${id}/invalidate`,{method:'PUT'}); const d=await r.json();
    displayJson('invalidateResult',d); updateStats(); loadFreeList(); loadActiveList(); showHistory(id);
  }

  async function deleteKey(id){
    const r=await fetch(`/keys/${id}`,{method:'DELETE'}); const d=await r.json();
    displayJson('deleteResult',d); updateStats(); loadFreeList(); loadActiveList(); document.getElementById('historyLog').textContent='';
  }

  async function showHistory(id){
    if(!id) return;
    const r=await fetch(`/keys/${id}/history`); const h=await r.json();
    displayJson('historyLog',h);
  }

  /* ----------------- Form Events ----------------- */
  document.getElementById('loadKeys').onclick=async()=>{
    const p=[];
    if(document.getElementById('filterInUse').checked) p.push('inUse=true');
    const as=document.getElementById('filterAssignedTo').value.trim();
    if(as) p.push('assignedTo='+encodeURIComponent(as));
    const r=await fetch('/keys'+(p.length?'?'+p.join('&'):'')); const d=await r.json();
    displayJson('allKeys',d); updateStats(); loadFreeList(); loadActiveList();
  };

  document.getElementById('addKeyForm').onsubmit=async e=>{
    e.preventDefault();
    const raw=document.getElementById('newKey').value;
    const keys=raw.split(/\r?\n/).map(k=>k.trim()).filter(Boolean);
    const r=await fetch('/keys',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({keys})});
    const d=await r.json(); displayJson('addKeyResult',d);
    updateStats(); loadFreeList(); loadActiveList(); if(d.length) showHistory(d[0].id);
  };

  document.getElementById('getFreeKey').onclick=async()=>{
    const r=await fetch('/keys/free'); const t=await r.text();
    showFreeKey(t); updateStats(); loadFreeList(); loadActiveList();
  };

  document.getElementById('markInUseForm').onsubmit=e=>{
    e.preventDefault();
    markKeyInUse(document.getElementById('keyId').value,document.getElementById('assignedTo').value);
  };

  document.getElementById('releaseForm').onsubmit=e=>{ e.preventDefault(); releaseKey(document.getElementById('releaseId').value); };
  document.getElementById('invalidateForm').onsubmit=e=>{ e.preventDefault(); invalidateKey(document.getElementById('invalidateId').value); };
  document.getElementById('deleteForm').onsubmit=e=>{ e.preventDefault(); deleteKey(document.getElementById('deleteId').value); };

  /* ----------------- Initial Load ----------------- */
  document.addEventListener('DOMContentLoaded',()=>{
    applyTheme(localStorage.getItem('theme'));
    sidebar.classList.toggle('hidden', window.innerWidth < 850);  /* mobile default-closed */
    updateStats(); loadFreeList(); loadActiveList();
  });
  </script>
</body>
</html>
