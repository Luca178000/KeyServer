<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Key Server Dashboard</title>
  <!-- Stylesheet für das Dashboard -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Dashboard mit verschiedenen Abschnitten -->
  <h1>Key Server Dashboard</h1>

  <section>
  <!-- Abschnitt: Statistik -->
    <h2>Statistik</h2>
    <div>Freie Keys: <span id="freeCount">0</span></div>
    <div>Benutzte Keys: <span id="usedCount">0</span></div>
  </section>

  <section>
  <!-- Abschnitt: Übersicht alle Keys -->
    <h2>Alle Keys</h2>
    <label><input type="checkbox" id="filterInUse" /> nur benutzte Keys</label>
    <input type="text" id="filterAssignedTo" placeholder="Zugewiesen an" />
    <button id="loadKeys">Laden</button>
    <pre id="allKeys"></pre>
  </section>

  <section>
  <!-- Abschnitt: Liste freie Keys -->
    <h2>Freie Keys</h2>
    <pre id="listFree"></pre>
  </section>

  <section>
  <!-- Abschnitt: Liste aktive Keys -->
    <h2>Aktive Keys</h2>
    <pre id="listActive"></pre>
  </section>

  <section>
  <!-- Abschnitt: Key hinzufügen -->
    <h2>Neuen Key hinzufügen</h2>
    <form id="addKeyForm">
      <textarea id="newKey" placeholder="XXXXX-XXXXX-XXXXX-XXXXX" required></textarea>
      <button type="submit">Hinzufügen</button>
    </form>
    <pre id="addKeyResult"></pre>
  </section>

  <section>
  <!-- Abschnitt: Freien Key abrufen -->
    <h2>Freien Key abrufen</h2>
    <button id="getFreeKey">Abrufen</button>
    <pre id="freeKey"></pre>
  </section>

  <section>
  <!-- Abschnitt: Key als benutzt markieren -->
    <h2>Key als benutzt markieren</h2>
    <form id="markInUseForm">
      <input type="number" id="keyId" placeholder="ID" required />
      <input type="text" id="assignedTo" placeholder="Zugewiesen an" />
      <button type="submit">Markieren</button>
    </form>
    <pre id="inUseResult"></pre>
  </section>

  <section>
  <!-- Abschnitt: Key freigeben -->
    <h2>Key freigeben</h2>
    <form id="releaseForm">
      <input type="number" id="releaseId" placeholder="ID" required />
      <button type="submit">Freigeben</button>
    </form>
    <pre id="releaseResult"></pre>
  </section>

  <section>
  <!-- Abschnitt: Key ungültig markieren -->
    <h2>Key ungültig markieren</h2>
    <form id="invalidateForm">
      <input type="number" id="invalidateId" placeholder="ID" required />
      <button type="submit">Key ungültig</button>
    </form>
    <pre id="invalidateResult"></pre>
  </section>

  <section>
  <!-- Abschnitt: Key löschen -->
    <h2>Key l\xC3\xB6schen</h2>
    <form id="deleteForm">
      <input type="number" id="deleteId" placeholder="ID" required />
      <button type="submit">L\xC3\xB6schen</button>
    </form>
    <pre id="deleteResult"></pre>
  </section>

  <section>
  <!-- Abschnitt: Log anzeigen -->
    <h2>Log</h2>
    <pre id="historyLog"></pre>
  </section>

  <script>
    async function updateStats() {
      const res = await fetch('/keys');
      const data = await res.json();
      const free = data.filter(k => !k.inUse).length;
      const used = data.filter(k => k.inUse).length;
      document.getElementById('freeCount').textContent = free;
      document.getElementById('usedCount').textContent = used;
    }

    async function loadFreeList() {
      const res = await fetch('/keys/free/list');
      const data = await res.json();
      document.getElementById('listFree').textContent = JSON.stringify(data, null, 2);
    }

    async function loadActiveList() {
      const res = await fetch('/keys/active/list');
      const data = await res.json();
      document.getElementById('listActive').textContent = JSON.stringify(data, null, 2);
    }

    async function showHistory(id) {
      if (!id) return;
      const res = await fetch(`/keys/${id}/history`);
      const hist = await res.json();
      document.getElementById('historyLog').textContent = JSON.stringify(hist, null, 2);
    }

    document.getElementById('loadKeys').addEventListener('click', async () => {
      // Query-Parameter für die Filter zusammenstellen
      const params = [];
      const inUseChecked = document.getElementById('filterInUse').checked;
      if (inUseChecked) params.push('inUse=true');
      const assigned = document.getElementById('filterAssignedTo').value.trim();
      if (assigned) params.push('assignedTo=' + encodeURIComponent(assigned));
      const query = params.length ? '?' + params.join('&') : '';

      const res = await fetch('/keys' + query);
      const data = await res.json();
      document.getElementById('allKeys').textContent = JSON.stringify(data, null, 2);
      updateStats();
      loadFreeList();
      loadActiveList();
    });

    document.getElementById('addKeyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // Inhalt des Textfeldes auslesen und in einzelne Zeilen aufteilen
      const raw = document.getElementById('newKey').value;
      const keys = raw.split(/\r?\n/).map(k => k.trim()).filter(Boolean);

      // Anfrage an den Server schicken, wobei ein Array von Keys übertragen wird
      const res = await fetch('/keys', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keys })
      });

      // Serverantwort anzeigen
      const data = await res.json();
      document.getElementById('addKeyResult').textContent = JSON.stringify(data, null, 2);
      updateStats();
      loadFreeList();
      loadActiveList();
      if (data.length > 0) showHistory(data[0].id);
    });

    document.getElementById('getFreeKey').addEventListener('click', async () => {
      const res = await fetch('/keys/free');
      const data = await res.json();
      document.getElementById('freeKey').textContent = JSON.stringify(data, null, 2);
      updateStats();
      loadFreeList();
      loadActiveList();
      showHistory(data.id);
    });

    document.getElementById('markInUseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('keyId').value;
      const assignedTo = document.getElementById('assignedTo').value;
      const res = await fetch(`/keys/${id}/inuse`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assignedTo })
      });
      const data = await res.json();
      document.getElementById('inUseResult').textContent = JSON.stringify(data, null, 2);
      updateStats();
      loadFreeList();
      loadActiveList();
      showHistory(id);
    });

    // Setzt einen Key über die API wieder auf frei
    async function releaseKey(id) {
      const res = await fetch(`/keys/${id}/release`, { method: 'PUT' });
      const data = await res.json();
      document.getElementById('releaseResult').textContent = JSON.stringify(data, null, 2);
      updateStats();
      loadFreeList();
      loadActiveList();
      showHistory(id);
      return data;
    }

    document.getElementById('releaseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('releaseId').value;
      await releaseKey(id);
    });

    // Markiert einen Key als ungültig
    async function invalidateKey(id) {
      const res = await fetch(`/keys/${id}/invalidate`, { method: 'PUT' });
      const data = await res.json();
      document.getElementById('invalidateResult').textContent = JSON.stringify(data, null, 2);
      updateStats();
      loadFreeList();
      loadActiveList();
      showHistory(id);
      return data;
    }

    document.getElementById('invalidateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('invalidateId').value;
      await invalidateKey(id);
    });

    // L\xC3\xB6scht einen Key permanent vom Server
    async function deleteKey(id) {
      const res = await fetch(`/keys/${id}`, { method: 'DELETE' });
      const data = await res.json();
      document.getElementById('deleteResult').textContent = JSON.stringify(data, null, 2);
      updateStats();
      loadFreeList();
      loadActiveList();
      // Nach dem L\xC3\xB6schen ist keine Historie mehr vorhanden
      document.getElementById('historyLog').textContent = '';
      return data;
    }

    document.getElementById('deleteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('deleteId').value;
      await deleteKey(id);
    });

    document.addEventListener('DOMContentLoaded', () => {
      updateStats();
      loadFreeList();
      loadActiveList();
    });
  </script>
</body>
</html>
