<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Key Server Dashboard</title>
  <!-- Einbindung des Stylesheets -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="container">
    <h1>Key Server Dashboard</h1>

    <div class="toolbar">
      <!-- Navigationsleiste f√ºr die einzelnen Tabs -->
      <nav class="tabs">
        <button data-tab="overview">√úbersicht</button>
        <button data-tab="actions">Aktionen</button>
        <button data-tab="history">Historie</button>
      </nav>
      <!-- Schalter f√ºr Dark-/Lightmode -->
      <button id="themeToggle" aria-label="Design wechseln">üåô</button>
    </div>
  </header>

  <main class="container">

  <!-- Tab: Statistik und Listen -->
  <div id="overview" class="tab-content">
    <section>
      <h2>Statistik</h2>
      <div>Freie Keys: <span id="freeCount">0</span></div>
      <div>Benutzte Keys: <span id="usedCount">0</span></div>
      <div>Ung√ºltige Keys: <span id="invalidCount">0</span></div>
    </section>

    <section>
      <h2>Freie Keys</h2>
      <div id="listFree" class="key-list"></div>
    </section>

    <section>
      <h2>Aktivierte Keys</h2>
      <div id="listActive" class="key-list"></div>
    </section>
  </div>

  <!-- Tab: Aktionen f√ºr einzelne Keys -->
  <div id="actions" class="tab-content">
    <section>
      <h2>Alle Keys</h2>
      <label><input type="checkbox" id="filterInUse"> nur benutzte Keys</label>
      <input type="text" id="filterAssignedTo" placeholder="Zugewiesen an">
      <button id="loadKeys">Laden</button>
      <div id="allKeys" class="result-box"></div>
    </section>

    <section>
      <h2>Neuen Key hinzuf√ºgen</h2>
      <form id="addKeyForm">
        <textarea id="newKey" placeholder="XXXXX-XXXXX-XXXXX-XXXXX" required></textarea>
        <button type="submit">Hinzuf√ºgen</button>
      </form>
      <div id="addKeyResult" class="result-box"></div>
    </section>

    <section>
      <h2>Freien Key abrufen</h2>
      <button id="getFreeKey">Abrufen</button>
      <div id="freeKey" class="result-box"></div>
    </section>

    <section>
      <h2>Key als benutzt markieren</h2>
      <form id="markInUseForm">
        <input type="number" id="keyId" placeholder="ID" required>
        <input type="text" id="assignedTo" placeholder="Zugewiesen an">
        <button type="submit">Markieren</button>
      </form>
      <div id="inUseResult" class="result-box"></div>
    </section>

    <section>
      <h2>Key freigeben</h2>
      <form id="releaseForm">
        <input type="number" id="releaseId" placeholder="ID" required>
        <button type="submit">Freigeben</button>
      </form>
      <div id="releaseResult" class="result-box"></div>
    </section>

    <section>
      <h2>Key ung√ºltig markieren</h2>
      <form id="invalidateForm">
        <input type="number" id="invalidateId" placeholder="ID" required>
        <button type="submit">Key ung√ºltig</button>
      </form>
      <div id="invalidateResult" class="result-box"></div>
    </section>

    <section>
      <h2>Key l√∂schen</h2>
      <form id="deleteForm">
        <input type="number" id="deleteId" placeholder="ID" required>
        <button type="submit">L√∂schen</button>
      </form>
      <div id="deleteResult" class="result-box"></div>
    </section>
  </div>

  <!-- Tab: Anzeige der Historie -->
  <div id="history" class="tab-content">
    <section>
      <h2>Log</h2>
      <div id="historyLog" class="result-box" style="white-space: pre-wrap;"></div>
    </section>
  </div>

  </main>

  <script>

    /*
     * Schaltet zwischen hellem und dunklem Design um. Die Auswahl
     * wird in localStorage gesichert und beim Laden wiederhergestellt.
     */
    const themeToggle = document.getElementById('themeToggle');

    function applyTheme(mode) {
      document.body.classList.remove('light', 'dark');
      if (mode) document.body.classList.add(mode);
    }

    themeToggle.addEventListener('click', () => {
      const current = document.body.classList.contains('dark') ? 'dark'
        : document.body.classList.contains('light') ? 'light' : null;
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      try { localStorage.setItem('theme', next); } catch (e) {}
    });

    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('theme');
      if (saved) applyTheme(saved);
    });

    // Erstellt einen Symbol-Button f√ºr die Key-Aktionen
    function createIconButton(icon, title, className, handler) {

      const btn = document.createElement('button');
      btn.className = 'icon-button ' + className;
      btn.textContent = icon;
      btn.title = title;
      btn.addEventListener('click', handler);
      return btn;
    }


    // Zeigt ein JSON-Objekt √ºbersichtlich in einer Ergebnisbox an
    function displayJson(id, obj) {
      const box = document.getElementById(id);
      box.innerHTML = '';
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(obj, null, 2);
      box.appendChild(pre);

    }

    // Stellt einen einzelnen Key mit Copy-Button dar
    function showFreeKey(data) {
      const box = document.getElementById('freeKey');
      box.innerHTML = '';
      if (!data || !data.key) return;

      const span = document.createElement('span');
      span.textContent = data.key;

      const copy = document.createElement('button');
      copy.textContent = 'Kopieren';
      copy.addEventListener('click', () => {
        navigator.clipboard.writeText(data.key).catch(() => {});
      });

      box.appendChild(span);
      box.appendChild(copy);
    }

    // Markiert einen Key als benutzt
    async function markKeyInUse(id, assignedTo = '') {
      const res = await fetch(`/keys/${id}/inuse`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assignedTo })
      });
      const data = await res.json();
      displayJson('inUseResult', data);
      updateStats();
      loadFreeList();
      loadActiveList();
      showHistory(id);
      return data;
    }

    // Rendert die Keys mit zugeh√∂rigen Aktionskn√∂pfen untereinander
    function renderList(targetId, data) {
      const container = document.getElementById(targetId);
      container.innerHTML = '';
      data.sort((a, b) => a.id - b.id);
      for (const entry of data) {
        const row = document.createElement('div');
        row.className = 'key-row';

        const text = document.createElement('span');
        text.textContent = `${entry.id}: ${entry.key}`;
        row.appendChild(text);

        const actions = document.createElement('div');
        actions.className = 'key-actions';

        actions.appendChild(createIconButton('‚úîÔ∏è', 'Benutzen', 'icon-button icon-use', () => {
          const assigned = prompt('Zugewiesen an?') || '';
          markKeyInUse(entry.id, assigned);
        }));

        actions.appendChild(createIconButton('‚Ü©Ô∏è', 'Freigeben', 'icon-button icon-release', () => {
          releaseKey(entry.id);
        }));

        actions.appendChild(createIconButton('üö´', 'Ung√ºltig', 'icon-button icon-invalidate', () => {
          invalidateKey(entry.id);
        }));

        actions.appendChild(createIconButton('üóëÔ∏è', 'L√∂schen', 'icon-button icon-delete', () => {
          deleteKey(entry.id);
        }));

        actions.appendChild(createIconButton('üìã', 'Kopieren', 'icon-button icon-copy', () => {
          navigator.clipboard.writeText(entry.key).catch(() => {});
        }));

        actions.appendChild(createIconButton('üìú', 'Historie', 'icon-button icon-history', () => {
          showHistory(entry.id);
          document.querySelector('nav.tabs button[data-tab="history"]').click();
        }));

        row.appendChild(actions);
        container.appendChild(row);
      }
    }

    async function updateStats() {
      const res = await fetch('/keys');
      const data = await res.json();
      const free = data.filter(k => !k.inUse).length;
      const used = data.filter(k => k.inUse).length;
      const invalid = data.filter(k => k.invalid).length;
      document.getElementById('freeCount').textContent = free;
      document.getElementById('usedCount').textContent = used;
      document.getElementById('invalidCount').textContent = invalid;
    }

    async function loadFreeList() {
      const res = await fetch('/keys/free/list');
      const data = await res.json();
      renderList('listFree', data);
    }

    async function loadActiveList() {
      const res = await fetch('/keys/active/list');
      const data = await res.json();
      renderList('listActive', data);
    }

    async function showHistory(id) {
      if (!id) return;
      const res = await fetch(`/keys/${id}/history`);
      const hist = await res.json();
      displayJson('historyLog', hist);
    }

    document.getElementById('loadKeys').addEventListener('click', async () => {
      const params = [];
      const inUseChecked = document.getElementById('filterInUse').checked;
      if (inUseChecked) params.push('inUse=true');
      const assigned = document.getElementById('filterAssignedTo').value.trim();
      if (assigned) params.push('assignedTo=' + encodeURIComponent(assigned));
      const query = params.length ? '?' + params.join('&') : '';

      const res = await fetch('/keys' + query);
      const data = await res.json();
      displayJson('allKeys', data);
      updateStats();
      loadFreeList();
      loadActiveList();
    });

    document.getElementById('addKeyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const raw = document.getElementById('newKey').value;
      const keys = raw.split(/\r?\n/).map(k => k.trim()).filter(Boolean);

      const res = await fetch('/keys', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keys })
      });

      const data = await res.json();
      displayJson('addKeyResult', data);
      updateStats();
      loadFreeList();
      loadActiveList();
      if (data.length > 0) showHistory(data[0].id);
    });

    document.getElementById('getFreeKey').addEventListener('click', async () => {
      const res = await fetch('/keys/free');
      const data = await res.json();
      showFreeKey(data);
      updateStats();
      loadFreeList();
      loadActiveList();
      showHistory(data.id);
    });

    document.getElementById('markInUseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('keyId').value;
      const assignedTo = document.getElementById('assignedTo').value;
      await markKeyInUse(id, assignedTo);
    });

    async function releaseKey(id) {
      const res = await fetch(`/keys/${id}/release`, { method: 'PUT' });
      const data = await res.json();
      displayJson('releaseResult', data);
      updateStats();
      loadFreeList();
      loadActiveList();
      showHistory(id);
      return data;
    }

    document.getElementById('releaseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('releaseId').value;
      await releaseKey(id);
    });

    async function invalidateKey(id) {
      const res = await fetch(`/keys/${id}/invalidate`, { method: 'PUT' });
      const data = await res.json();
      displayJson('invalidateResult', data);
      updateStats();
      loadFreeList();
      loadActiveList();
      showHistory(id);
      return data;
    }

    document.getElementById('invalidateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('invalidateId').value;
      await invalidateKey(id);
    });

    async function deleteKey(id) {
      const res = await fetch(`/keys/${id}`, { method: 'DELETE' });
      const data = await res.json();
      displayJson('deleteResult', data);
      updateStats();
      loadFreeList();
      loadActiveList();
      document.getElementById('historyLog').textContent = '';
      return data;
    }

    document.getElementById('deleteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('deleteId').value;
      await deleteKey(id);
    });

    // Tab-Umschaltung f√ºr die Navigation
    document.querySelectorAll('nav.tabs button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(c => {
          c.style.display = 'none';
        });
        document.getElementById(tab).style.display = 'block';
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelector('nav.tabs button').click();
      updateStats();
      loadFreeList();
      loadActiveList();
    });
  </script>
</body>
</html>
